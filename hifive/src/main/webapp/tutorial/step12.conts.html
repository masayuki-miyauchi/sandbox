<!-- CONTENTS_CSS_BEGIN -->
<link rel="stylesheet" href="css/article.css" type="text/css" />
<link type="text/css" rel="stylesheet"
	href="../lib/syntaxhighlighter/styles/SyntaxHighlighter.css"></link>
<!-- CONTENTS_CSS_END -->
<!-- CONTENTS_SCRIPT_BEGIN -->
<script type="text/javascript"
	src="../lib/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript"
	src="../lib/syntaxhighlighter/scripts/shBrushXml.js"></script>
<script type="text/javascript"
	src="../lib/syntaxhighlighter/scripts/shBrushJScript.js"></script>
<script type="text/javascript">
	window.onload = function() {
		dp.SyntaxHighlighter.ClipboardSwf = '../lib/syntaxhighlighter/scripts/clipboard.swf';
		dp.SyntaxHighlighter.HighlightAll('code');
	}
</script>
<!-- CONTENTS_SCRIPT_END -->
<!-- CONTENTS_MAIN_BEGIN -->
<div id="contents">
	<ul class="menu tutorialIndex">
		<li><a href="step01.html" title="01.準備">01.準備</a></li>
		<li><a href="step02.html" title="02.MVC構造">02.MVC構造</a></li>
		<li><a href="step03.html" title="03.HelloWorld">03.HelloWorld</a></li>
		<li><a href="step04.html" title="04.コントローラ">04.コントローラ</a></li>
		<li><a href="step05.html" title="05.ビュー操作">05.ビュー操作</a></li>
		<li><a href="step06.html" title="06.ロジック">06.ロジック</a></li>
		<li><a href="step07.html" title="07.非同期処理">07.非同期処理</a></li>
		<li><a href="step08.html" title="08.テスト">08.テスト</a></li>
		<li><a href="step09.html" title="09.ドキュメント記述・生成(JSDoc)">09.ドキュメント記述・生成(JSDoc)</a></li>
		<li><a href="step10.html" title="10.サンプルアプリ（動画検索アプリの作成）">10.サンプルアプリ（動画検索アプリの作成）</a></li>
		<li><a href="step11.html" title="11.スマートフォン対応（jQueryMobileとの連携）">11.スマートフォン対応（jQueryMobileとの連携）</a></li>
		<li><a href="step12.html" title="12.HTML5APIの利用">12.HTML5APIの利用</a></li>
        <li><a href="step13.html" title="13.AOP(アスペクトの適用)">13.AOP(アスペクトの適用)</a></li>
	</ul>
	<h1 class="title">チュートリアル12.HTML5APIの利用</h1>
	<div class="contents contents2">
		<input type="hidden" name="contents2Level" value="0"><input
			type="hidden" name="contents2Filter" value=""><input
			type="hidden" name="contents2Count" value="-1"><input
			type="hidden" name="contents2CountLevel" value="0">
		<ul class="list1">
			<li><a href="#capture025501">概要 </a></li>
		</ul>
		<ul class="list1">
			<li><a href="#capture125501">Geolocation API:現在位置(GPS)の取得 </a></li>
			<ul class="list2">
				<li><a href="#capture225501"> 現在位置の詐称 </a></li>
				<li><a href="#capture325501">ルートの詐称 </a></li>
				<li><a href="#capture425501">強制的なエラーの発生 </a></li>
			</ul>
		</ul>
		<ul class="list1">
			<li><a href="#capture525501">Web Storage：ローカルキーバリューストレージ </a></li>
		</ul>
		<ul class="list1">
			<li><a href="#capture625501">Web SQL Database：ローカルデータベース </a></li>
			<ul class="list2">
				<li><a href="#capture725501">単一テーブルに対するCRUD操作を比較的容易に行える </a></li>
				<li><a href="#capture825501">複数のSQLを同一トランザクションで処理する </a></li>
			</ul>
		</ul>
	</div>
	<a class="anchor_super" id="capture025501"></a><h2>
		概要
	</h2>
	<p>本章では、HTML5のAPI群をラップした、開発支援機能を説明します。コード中のh5.jsはh5.dev.js(開発支援機能ありver)を使用してください。</p>
	 <a class="anchor_super" id="capture125501"></a><h2>
		Geolocation API:現在位置(GPS)の取得
	</h2>
	<a class="anchor_super" id="capture225501"></a><h3>
		現在位置の詐称
	</h3>
	<p>getCurrentPositionのデバッグ支援機能し、ダミーの座標を設定するためのソースコードを生成します。</p>
	<p>
		<span class="strong">html</span>
	</p>
	<pre name="code" class="xml">&lt;!doctype html&gt;
&lt;html&gt;
&nbsp;&lt;head&gt;
&nbsp;&nbsp;&lt;script src="jquery.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&lt;script src="jquery.blockUI.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&lt;script src="ejs-1.0.h5mod.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&lt;script src="h5.js"&gt;&lt;/script&gt;
&nbsp;&lt;/head&gt;
&nbsp;&lt;body&gt;
&nbsp;&lt;/body&gt;
&lt;/html&gt;</pre>
	<p>
		<span class="strong">js</span>
	</p>
	<pre name="code" class="js">h5.dev.api.geo.dummyPositions = { coords: {latitude: 35.68505914147349,longitude: 139.76440876196284}};
&nbsp;
// ダミー座標としてパラメータに指定された座標を返す。
h5.api.geolocation.getCurrentPosition(function(pos) {
&nbsp;&nbsp;&nbsp;&nbsp;var lat = pos.coords.latitude, lng = pos.coords.longitude;
&nbsp;&nbsp;&nbsp;&nbsp;console.log(lat +", "+ lng); // 35.68505914147349, 139.76440876196284
});</pre>
	<a class="anchor_super" id="capture325501"></a><h3>
		ルートの詐称
	</h3>
	<p>watchPositonのデバッグ支援機能、移動体のダミー座標を設定するためのソースコードを生成します。</p>
	<p>
		<span class="strong">html</span>
	</p>
	<pre name="code" class="xml">&lt;!doctype html&gt;
&lt;html&gt;
&nbsp;&lt;head&gt;
&nbsp;&nbsp;&lt;script src="jquery.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&lt;script src="jquery.blockUI.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&lt;script src="ejs-1.0.h5mod.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&lt;script src="h5.js"&gt;&lt;/script&gt;
&nbsp;&lt;/head&gt;
&nbsp;&lt;body&gt;
&nbsp;&lt;/body&gt;
&lt;/html&gt;</pre>
	<p>
		<span class="strong">js</span>
	</p>
	<pre name="code" class="js">h5.dev.api.geo.watchIntervalTime = 1000;
// 配列で、ダミー座標を設定する。
h5.dev.api.geo.dummyPosition =&nbsp; [{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;latitude: 35.67920288784219,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;longitude: 139.7650095767821
&nbsp;&nbsp;&nbsp;&nbsp;}, {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;latitude: 35.68540771444479,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;longitude: 139.7660395450439
&nbsp;&nbsp;&nbsp;&nbsp;}, {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;latitude: 35.69802503048958,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;longitude: 139.7729918308105
&nbsp;&nbsp;&nbsp;&nbsp;}];
&nbsp;
// 1000ms毎にh5.dev.api.geo.setDummyWatchPositionメソッドで設定したダミー座標を返す
h5.api.geolocation.watchPosition().progress(function(pos) {
&nbsp;&nbsp;&nbsp;&nbsp;var lat = pos.coords.latitude, lng = pos.coords.longitude;
&nbsp;&nbsp;&nbsp;&nbsp;console.log(lat +", "+ lng);
});</pre>
	<a class="anchor_super" id="capture425501"></a><h3>
		強制的なエラーの発生
	</h3>
	<p>強制的に、getCurrentPosition/watchPositionのエラーコールバックを実行する。</p>
	<pre name="code" class="js">h5.dev.api.geo.isForceError = true;
&nbsp;
h5.api.geolocation.watchPosition.progress(function(pos) {
&nbsp;
}).fail((function(error) {
&nbsp;&nbsp;&nbsp;&nbsp;// 強制的にエラーコールバックが実行される
});</pre>
	<a class="anchor_super" id="capture525501"></a><h2>
		Web Storage：ローカルキーバリューストレージ
	</h2>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>setItem(key, value)で値の型判定を行い、型情報を付与した文字列をストレージに保存します。
			<ul class="list2" style="padding-left: 12px; margin-left: 12px">
				<li>h5.api.storage.local.setItem</li>
				<li>h5.api.storage.session.setItem</li>
			</ul>
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>getItem(key)で、setItem()時に行った型判定の情報に基づき、ストレージに保存されている文字列から適切な型に変換して返します。
			<ul class="list2" style="padding-left: 12px; margin-left: 12px">
				<li>h5.api.storage.local.getItem</li>
				<li>h5.api.storage.session.getItem</li>
			</ul>
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>オブジェクトの中に格納されているオブジェクトも正しく変換します。</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>扱うことができる型は以下の通りです。
			<ul class="list2" style="padding-left: 12px; margin-left: 12px">
				<li>string(文字列)</li>
				<li>number(数値)</li>
				<li>boolean(真偽値)</li>
				<li>String(文字列のラッパークラス型)</li>
				<li>Number(数値のラッパークラス型)</li>
				<li>Boolean(真偽値のラッパークラス型)</li>
				<li>array(配列)</li>
				<li>object(プレーンオブジェクト [new Object() または {…} のリテラルで作られたオブジェクト])</li>
				<li>Date(日付)</li>
				<li>RegExp(正規表現)</li>
				<li>undefined</li>
				<li>null</li>
				<li>NaN</li>
				<li>Infinity</li>
				<li>-Infinity</li>
			</ul>
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>キーに紐付けてデータを一時的に保存したり、データとして保存したい場合は、このAPIが適しています。<br>また、ローカルストレージAPIはIE(8以上)、Chrome、FireFox、Safari、Operaと、主要ブラウザすべてがサポートしています。
		</li>
	</ul>
	<p>サンプルコード</p>
	<pre name="code" class="js">h5.api.storage.local.setItem('key3', [10, 'AAA']);
&nbsp;
var item = h5.api.storage.local.getItem('key3'); // Array型のオブジェクトを取得できる
console.log(item)
console.log(item[1]); // AAA</pre>
	<a class="anchor_super" id="capture625501"></a><h2>
		Web SQL Database：ローカルデータベース
	</h2>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>2010年11月18日に仕様策定は停止され事実上廃止となってしまいましたが、現在もChromeとSafariでは使用することができます。</li>
		<li>現在Web SQL Databaseにかわるローカルデータベースとして、Indexed Database の仕様を策定中。</li>
		<li>データ構造に基づいて、WHERE句などで条件を指定してクエリを行いたいデータを保存する場合は、このAPIが適しています。</li>
	</ul>
	<p>
		hifiveのSQL Database
		APIはビルダーパターンのようになっており、データベースをオープン後SQL実行オブジェクトを生成し、そのオブジェクトに対してWHEREやORDERBYといった情報を設定します。<br>そして、SQL実行オブジェクトが持つ<span
			class="strong">execute()</span>を呼び出しSQLを実行します。結果はjQuery.DeferrdのPromiseオブジェクトによって返されます。
	</p>
	<pre name="code" class="js">// データベースをオープンする
var db = h5.api.sqldb.open('db1', '1.0', 'db1', 1024*1024);
// SQL実行オブジェクトを生成する
var select = db.select('TABLE1', ['COLUMN1','COLUMN3']).where({'COLUMN2 !=': 'AAAA'});
// Promiseオブジェクト
var promise = select.execute(); // SQLを実行
&nbsp;
// 実行結果をPromiseオブジェクトから取得
promise.done(function(resultset) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// トランザクション完了
}).fail(function(error) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// トランザクションエラー
}).progress(function(resultset, tx) {
&nbsp;&nbsp;&nbsp;// 同一トランザクションで続けてSQLを実行できる。
&nbsp;&nbsp;&nbsp;var del = db.del('TABLE1' tx);
&nbsp;&nbsp;&nbsp;del.where({COLUMN1: 'suzuki').execute().done(function(rs2) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;});
});</pre>
	<a class="anchor_super" id="capture725501"></a><h3>
		単一テーブルに対するCRUD操作を比較的容易に行える
	</h3>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<li>SELECT</li>
		</ul>
	</ul>
	<p>
		<span class="strong">例: MEMBERテーブルから、AGEが20以上のレコードを取得する。</span>
	</p>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>ネイティブ<pre name="code" class="js">transaction.executeSql('SELECT NAME, BIRTHDAY FROM MEMBER WHERE AGE &gt;= ?', [20], function(rs) {
&nbsp;&nbsp;&nbsp;&nbsp;var result = rs.rows;
&nbsp;&nbsp;&nbsp;&nbsp;for (var i = 0, len = result.length; i &lt; len; i++) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var row = result.item(i);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(row.COLUMN1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(row.COLUMN2);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(row.COLUMN3);
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
				</li>
				<li>hifive<pre name="code" class="js">var db = h5.api.sqldb.open('db1', '1.0', 'db1', 1024*1024);
var select = db.select('MEMBER', ['NAME','BIRTHDAY']).where({'AGE &gt;=': 20});
var promise = select.execute();
&nbsp;
promise.done(function(rowItems) {
&nbsp;&nbsp;&nbsp;&nbsp;for (var i = 0, len = rowItems.length; i &lt; len; i++) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var row = rowItems.item(i);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(row.COLUMN1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(row.COLUMN2);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(row.COLUMN3);
&nbsp;&nbsp;&nbsp;&nbsp;}
});</pre>
				</li>
			</ul>
			<li>INSERT</li>
		</ul>
	</ul>
	<p>
		<span class="strong">例: MEMBERテーブルに、レコード(NAME="tanaka"
			BIRTH="1990/1/1" AGE=30)を追加する。</span>
	</p>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>ネイティブ<pre name="code" class="js">transaction.executeSql('INSERT INTO MEMBER VALUES (?, ?, ?)', ['tanaka', '1990/1/1', 30], function(rs) {
&nbsp;&nbsp;&nbsp;&nbsp;rs.insertId // 値が入っていれば登録されている
}</pre>
				</li>
			</ul>
		</ul>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>hifive<pre name="code" class="js">var db = h5.api.sqldb.open('db1', '1.0', 'db1', 1024*1024);
var insert = db.insert('MEMBER', {NAME:'tanaka', BIRTH:'1990/1/1', AGE:30});
var promise = insert.execute();
&nbsp;
promise.done(function(insertId) {
&nbsp;&nbsp;&nbsp;&nbsp;console.log(insertId) // レコードID
});</pre>
				</li>
			</ul>
		</ul>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<li>UPDATE</li>
		</ul>
	</ul>
	<p>
		<span class="strong">例: MEMBERテーブルの、AGEが30のレコードを更新する。</span>
	</p>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>ネイティブ<pre name="code" class="js">transaction.executeSql('UPDATE MEMBER SET NAME = ?, BIRTH = ? WHERE AGE = ?', ['suzuki', '1980/2/1', 30], function(rs) {
&nbsp;&nbsp;&nbsp;&nbsp;rs.rowsAffected // 変更のあったレコードの件数
}</pre>
				</li>
			</ul>
		</ul>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>hifive<pre name="code" class="js">var db = h5.api.sqldb.open('db1', '1.0', 'db1', 1024*1024);
var update = db.update('MEMBER', {NAME:'suzuki', BIRTH:'1980/2/1'});
var promise = update.where({'AGE &gt;=': 30}).execute();
&nbsp;
promise.done(function(updateCount) {
&nbsp;&nbsp;&nbsp;&nbsp;console.log(updateCount) // 更新件数
});</pre>
				</li>
			</ul>
			<li>DELETE</li>
		</ul>
	</ul>
	<p>
		<span class="strong">例: MEMBERテーブルの、AGEが30以外のレコードを削除する。</span>
	</p>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>ネイティブ<pre name="code" class="js">transaction.executeSql('DELETE FROM MEMBER WHEREE AGE != ?', [30], function(rs) {
&nbsp;&nbsp;&nbsp;&nbsp;rs.rowsAffected // 変更のあったレコードの件数
}</pre>
				</li>
			</ul>
		</ul>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<ul class="list3" style="padding-left: 12px; margin-left: 12px">
				<li>hifive<pre name="code" class="js">var db = h5.api.sqldb.open('db1', '1.0', 'db1', 1024*1024);
var del = db.del('MEMBER');
var promise = del.where({'AGE !=': 30}).execute();
&nbsp;
promise.done(function(deleteCount) {
&nbsp;&nbsp;&nbsp;&nbsp;console.log(deleteCount) // 削除件数
});</pre>
				</li>
			</ul>
		</ul>
	</ul>
	<a class="anchor_super" id="capture825501"></a><h3>
		複数のSQLを同一トランザクションで処理する
	</h3>
	<p>
		hifiveには、複数のSQLを1トランザクションで処理する<span class="strong">Transaction</span>クラスがあります。このクラスのメソッドである<span
			class="strong">add()</span>に実行するSQLオブジェクトを追加することで、追加した順番でSQL実行後、結果をまとめて取得することができます。
	</p>
	<pre name="code" class="js">var db = h5.api.sqldb.open('db1', '1.0', 'db1', 1024*1024);
var select1 = db.select('TABLE1', ['COLUMN1','COLUMN3']).where({'COLUMN2 !=': 'AAAA'});
var select2 = db.select('TABLE2', ['COLUMN2','COLUMN4']);
var select3 = db.select('TABLE3', '*').where({'COLUMN1 &gt;=': 100});
&nbsp;
var transaction = db.transaction();
var promise = transaction.add(select1).add(select2).add(select3).execute();
&nbsp;&nbsp;
promise.done(function(resultArray) {
&nbsp;&nbsp;&nbsp;&nbsp;// 配列resultArrayには、select1、select2、select3の順で結果が格納されている
});</pre>
	<p></p>
    <div class="spacer">&nbsp;</div>
    <div class="spacer">&nbsp;</div>
    <div style="text-align: center">
        <span
            style="font-size: 18px; display: inline; line-height: 130%; text-indent: 0px">次のステップ⇒<a
            href="step13.html">チュートリアル13.AOP(アスペクトの適用)</a></span>
    </div>
</div>
<!-- CONTENTS_MAIN_END -->