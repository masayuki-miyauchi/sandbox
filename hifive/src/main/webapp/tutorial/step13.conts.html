<!-- CONTENTS_CSS_BEGIN -->
<link rel="stylesheet" href="css/article.css" type="text/css" />
<link type="text/css" rel="stylesheet"
	href="../lib/syntaxhighlighter/styles/SyntaxHighlighter.css"></link>
<!-- CONTENTS_CSS_END -->
<!-- CONTENTS_SCRIPT_BEGIN -->
<script type="text/javascript"
	src="../lib/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript"
	src="../lib/syntaxhighlighter/scripts/shBrushXml.js"></script>
<script type="text/javascript"
	src="../lib/syntaxhighlighter/scripts/shBrushJScript.js"></script>
<script type="text/javascript">
	window.onload = function() {
		dp.SyntaxHighlighter.ClipboardSwf = '../lib/syntaxhighlighter/scripts/clipboard.swf';
		dp.SyntaxHighlighter.HighlightAll('code');
	}
</script>
<!-- CONTENTS_SCRIPT_END -->
<!-- CONTENTS_MAIN_BEGIN -->
<div id="contents">
	<ul class="menu tutorialIndex">
		<li><a href="step01.html" title="01.準備">01.準備</a></li>
		<li><a href="step02.html" title="02.MVC構造">02.MVC構造</a></li>
		<li><a href="step03.html" title="03.HelloWorld">03.HelloWorld</a></li>
		<li><a href="step04.html" title="04.コントローラ">04.コントローラ</a></li>
		<li><a href="step05.html" title="05.ビュー操作">05.ビュー操作</a></li>
		<li><a href="step06.html" title="06.ロジック">06.ロジック</a></li>
		<li><a href="step07.html" title="07.非同期処理">07.非同期処理</a></li>
		<li><a href="step08.html" title="08.テスト">08.テスト</a></li>
		<li><a href="step09.html" title="09.ドキュメント記述・生成(JSDoc)">09.ドキュメント記述・生成(JSDoc)</a></li>
		<li><a href="step10.html" title="10.サンプルアプリ（動画検索アプリの作成）">10.サンプルアプリ（動画検索アプリの作成）</a></li>
		<li><a href="step11.html" title="11.スマートフォン対応（jQueryMobileとの連携）">11.スマートフォン対応（jQueryMobileとの連携）</a></li>
		<li><a href="step12.html" title="12.HTML5APIの利用">12.HTML5APIの利用</a></li>
		<li><a href="step13.html" title="13.AOP(アスペクトの適用)">13.AOP(アスペクトの適用)</a></li>
	</ul>
	<h1 class="title">チュートリアル13.AOP(アスペクトの適用)</h1>
	<div class="contents contents2">
		<input type="hidden" name="contents2Level" value="0"><input
			type="hidden" name="contents2Filter" value=""><input
			type="hidden" name="contents2Count" value="-1"><input
			type="hidden" name="contents2CountLevel" value="0">
		<ul class="list1">
			<li><a href="#capture025488"> 概要 </a></li>
		</ul>
		<ul class="list1">
			<li><a href="#capture125488"> アスペクトの適用方法 </a></li>
		</ul>
		<ul class="list1">
			<li><a href="#capture225488"> 動作確認 </a></li>
		</ul>
		<ul class="list1">
			<li><a href="#capture325488"> 独自アスペクトの作り方 </a></li>
			<ul class="list2">
				<li><a href="#capture425488"> ターゲットとポイントカット </a></li>
				<ul class="list3">
					<li><a href="#capture525488"> 正規表現の場合 </a></li>
					<li><a href="#capture625488"> 文字列の場合 </a></li>
				</ul>
			</ul>
			<ul class="list2">
				<li><a href="#capture725488"> インターセプタ </a></li>
				<ul class="list3">
					<li><a href="#capture825488"> h5.u.createInterceptor </a></li>
				</ul>
			</ul>
			<ul class="list2">
				<li><a href="#capture925488"> 適用方法 </a></li>
				<ul class="list3">
					<li><a href="#capture1025488"> インターセプタの実行順序 </a></li>
				</ul>
			</ul>
			<ul class="list2">
				<li><a href="#capture1125488"> 実装例 </a></li>
			</ul>
		</ul>
	</div>
	<a class="anchor_super" id="capture025488"></a>
	<h2>概要</h2>
	<p>
		hifiveではコントローラとロジックのメソッドにアスペクトを適用(AOP)することができます。<br>AOPのメリットは「コードに変更を加えずに新たな処理を追加すること」ができる点です。<br>例えば既存のメソッドを修正せずにログ出力するようにしたり、そのメソッドの実行時間の計測ができるようになります。<br>
	</p>
	<a class="anchor_super" id="capture125488"></a>
	<h2>アスペクトの適用方法</h2>
	<p>
		ステップ3で作成した<a href="../tutorial/step3/step3.html" rel="nofollow">Hello
			World</a>にアスペクトを適用します。
	</p>
	<ol class="list1" style="padding-left: 12px; margin-left: 12px">
		<li><span class="strong">h5preinit.js</span>というファイルを新しく作成し、<span
			class="strong">h5.js</span>よりも先に読み込ませます。<pre name="code" class="xml">&lt;!-- hifiveのpreinitイベントで処理をさせるために、h5.jsより先に読み込む --&gt;
&lt;script src="h5preinit.js"&gt;&lt;/script&gt;
&lt;script src="h5.js"&gt;&lt;/script&gt;</pre></li>
		<li>h5preinit.jsは内容は以下の通りです。<pre name="code" class="js">$(document).bind('h5preinit', function() {
&nbsp;&nbsp;&nbsp;&nbsp;var aspect = {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target: 'HelloWorldController',
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interceptors: h5.core.interceptor.lap,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pointCut: '#btn click'
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;h5.settings.aspects = [aspect];
});</pre>
		</li>
	</ol>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>アスペクトはhifiveの独自イベント<span class="strong">h5preinit</span>イベントで指定します。<br
			class="spacer">詳細は後述します。
		</li>
		<li>2行目から6行目までがアスペクトの定義です。アスペクトはターゲットとインターセプタ、ポイントカットで構成されます。<br
			class="spacer">それぞれの詳細については後述します。
			<ul class="list2" style="padding-left: 12px; margin-left: 12px">
				<li>ターゲットはどのコントローラ、ロジックにインターセプタを適用するかを指定します。、ここでは名前が"HelloWorldController"であるコントローラに適用しています。</li>
				<li>インターセプタとは適用したい処理のことです。ここではhifiveが用意しているイベントハンドラが終了するまでの時間を計測しコンソールに出力する実行時間計測用インターセプタを指定しています。</li>
				<li>ポイントカットはインターセプタをどこに適用するかを指定します。ここでは"#btn
					click"メソッドに適用しています。</li>
			</ul></li>
	</ul>
	<a class="anchor_super" id="capture225488"></a>
	<h2>動作確認</h2>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li><a href="../tutorial/step13-1/step13-1.html" rel="nofollow">チュートリアル/ステップ13-1</a></li>
	</ul>
	<a class="anchor_super" id="capture325488"></a>
	<h2>独自アスペクトの作り方</h2>
	<p>
		hifiveのアスペクトは、<span class="strong">target</span>, <span class="strong">interceptors</span>,
		<span class="strong">pointCut</span>の3つのプロパティを持つオブジェクトです。<br>基本的な形は以下のようになります。
	</p>
	<pre name="code" class="js">var aspect = {
&nbsp;&nbsp;target: {String | RegExp},
&nbsp;&nbsp;interceptors: {Function | Function[]},
&nbsp;&nbsp;pointCut: {String | RegExp}
};</pre>
	<a class="anchor_super" id="capture425488"></a>
	<h3>ターゲットとポイントカット</h3>
	<p>
		ターゲットはインターセプタをどのコントローラ、ロジックに適用するかを、ポイントカットはどのメソッドに適用するかを定義します。<br>
	</p>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>ターゲットは、コントローラ、ロジックを定義する時の必須プロパティ<span class="strong">__name</span>に対して<br>指定された値で判定を行います。
		</li>
		<li>ポイントカットは、ターゲットにマッチしたコントローラ、ロジックのメソッド名に対して<br>指定された値で判定を行います。
		</li>
		<li>インターセプタが適用されるのは、ターゲット、ポイントカットの両方にマッチした時のみです。</li>
		<li>ターゲットとポイントカットは省略することができます。省略した場合、それぞれ「すべてのコントローラ、ロジック」、「すべてのメソッド」という意味になります。</li>
	</ul>
	<p>
		ターゲット、ポイントカットには<span class="strong">正規表現</span>と<span class="strong">文字列</span>を指定することができます。
	</p>
	<a class="anchor_super" id="capture525488"></a>
	<h4>
		正規表現の場合
	</h4>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>指定された正規表現でそのまま判定を行います。</li>
	</ul>
	<a class="anchor_super" id="capture625488"></a>
	<h4>
		文字列の場合
	</h4>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>*による部分一致のみが可能になります。
			<ul class="list2" style="padding-left: 12px; margin-left: 12px">
				<li>.や^など正規表現において特別な意味を持つものについては<span class="strong">*</span>を除いてすべてエスケープします。
				</li>
			</ul>
		</li>
		<li>暗黙的に始まりと終わりを追加します(/^{指定した文字列}$/ となります)。</li>
		<li>例としてターゲットを<span class="strong">jp.co.nssol.sample.controller*</span>としたとします。
			<ul class="list2" style="padding-left: 12px; margin-left: 12px">
				<li>__nameプロパティが"jp.co.nssol.sample.controller.TestController"であるコントローラはマッチします。</li>
				<li>__nameプロパティが"jp.co.nssol.sample2.controller.TestController"であるコントローラはマッチしません。</li>
			</ul></li>
	</ul>
	<a class="anchor_super" id="capture725488"></a>
	<h3>
		インターセプタ
	</h3>
	<p>インターセプタは実行したい処理を定義します。</p>
	<pre name="code" class="js">var interceptor = function(invocation) {};</pre>
	<p>
		インターセプタは引数<span class="strong">invocation</span>を取る関数として定義します。<br>インターセプタ内の<span
			class="strong">this</span>はコントローラで適用された場合そのコントローラ自身を、ロジックで適用された場合そのロジック自身となります。<br>invocationのメソッドプロパティは以下の通りです。
	</p>
	<dl class="list1" style="padding-left: 12px; margin-left: 12px">
		<dt>args</dt>
		<dd>元のメソッドに渡された引数が格納されています。型はArgumentsです。</dd>
		<dt>funcName</dt>
		<dd>元のメソッド名が格納されています。</dd>
		<dt>proceed</dt>
		<dd>次のインターセプタ、もしくは元のメソッドを実行します。</dd>
	</dl>
	<h4>
		h5.u.createInterceptor <a class="anchor_super" id="capture825488"></a>
	</h4>
	<p>インターセプタは定型の実装になることが多いため、ユーティリティを用意しています。</p>
	<pre name="code" class="js">h5.u.createInterceptor(pre, post);</pre>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>preはインターセプト先関数の実行前に呼ばれる関数です。</li>
		<li>postはインターセプト先関数の実行後に呼ばれる関数です。</li>
		<li>詳細については<a
			href="http://www.htmlhifive.com/ja/doc/h5.u.html#createInterceptor"
			rel="nofollow">こちら</a>を参照してください。
		</li>
	</ul>
	<p>以下は関数の実行前後にアラートを表示するインターセプタの例です。</p>
	<pre name="code" class="js">var alertInterceptor = h5.u.createInterceptor(function(invocation, data) {
&nbsp;&nbsp;&nbsp;&nbsp;alert('before');
&nbsp;&nbsp;&nbsp;&nbsp;return invocation.proceed();
}, function(invocation, data) {
&nbsp;&nbsp;&nbsp;&nbsp;alert('after);
});</pre>
    <a class="anchor_super" id="capture925488"></a>
	<h3>
		適用方法
	</h3>
	<p>
		アスペクトは<span class="strong">h5preinit</span>イベントで<span class="strong">h5.settings.aspects</span>に指定します。
	</p>
	<pre name="code" class="js">$(document).bind('h5preinit', function() {
&nbsp;&nbsp;var aspect = {
&nbsp;&nbsp;&nbsp;&nbsp;interceptors: function() { console.log('aspect execute.'); }
&nbsp;&nbsp;};
&nbsp;&nbsp;h5.settings.aspects = aspect;
});</pre>
    <a class="anchor_super" id="capture1025488"></a>
	<h4>
		インターセプタの実行順序
	</h4>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>アスペクト、またアスペクトのinterceptorsプロパティは値として配列を取ることができます。</li>
		<li>例えば以下のようにアスペクトを指定した場合、<pre name="code" class="js">$(document).bind('h5preinit', function() {
&nbsp;&nbsp;var aspect1 = {
&nbsp;&nbsp;&nbsp;&nbsp;interceptors: [func1, func2]
&nbsp;&nbsp;};
&nbsp;&nbsp;var aspect2 = {
&nbsp;&nbsp;&nbsp;&nbsp;interceptors: func3
&nbsp;&nbsp;};
&nbsp;&nbsp;h5.settings.aspects = [aspect1, aspect2];
});</pre> あるメソッドにかかるインターセプタの実行順は、<pre name="code" class="plain">func1 -&gt; func2 -&gt; func3 -&gt; 本来のメソッド</pre>
			となります。<br>インターセプタの実行順は定義した順と一致します。
		</li>
		<li>もちろん、ターゲット、ポイントカットにマッチしない場合は、インターセプタは実行されません。</li>
	</ul>
	<a class="anchor_super" id="capture1125488"></a>
	<h3>
		実装例
	</h3>
	<p>ここではボタンを押すと、ループを100万回回すロジックのメソッドの開始と終了をコンソールに出力するサンプルアプリケーションを作成します。</p>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>HTML<pre name="code" class="xml">&lt;!doctype html&gt;
&lt;html&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta charset="UTF-8"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta http-equiv="Pragma" content="no-cache"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta http-equiv="Cache-Control" content="no-cache"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta http-equiv="Expires" content="-1"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script src="jquery.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script src="ejs-1.0.h5mod.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script src="jquery.blockUI.js"&gt;&lt;/script&gt;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- hifiveのpreinitイベントで処理をさせるために、h5.jsより先に読み込む --&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script src="h5preinit.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- 各モジュールのソースJSを読み込む --&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script src="../../release/h5.js"&gt;&lt;/script&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- ここで作成したjsファイルを読み込む --&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script src="step13-2.js"&gt;&lt;/script&gt;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;hifive Aspectの適用&lt;/title&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class="browserNotification"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;※ブラウザはできるだけ最新のバージョンをご利用ください。&lt;br&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　特に、IE6/7等の古いブラウザでは正しく動作しない場合があります。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div id="container"&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type="button" id="btn" value="click"/&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;
&lt;/html&gt;</pre> HTMLはボタンがあるだけです。
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>アスペクト<pre name="code" class="js">$(document).bind('h5preinit', function() {
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var aspect = {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target: /^loop.*$/i,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interceptors: function(invocation) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.log.info(invocation.funcName + 'が開始されました。');
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;invocation.proceed();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.log.info(invocation.funcName + 'が終了しました。');
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pointCut: 'lo*'
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;h5.settings.aspects = aspect;
});</pre> invocationの実行(invocation.proceed())前後にコンソールにメッセージを出力しています。<br>ターゲットは正規表現で指定します。意味は「大文字小文字関係なく"loop"で始まるもの」です。<br>ポインカットは文字列です。*を使って部分一致を行っています。意味は「loで始まるもの」です。
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>ロジック<pre name="code" class="js">function LoopLogic() {}
LoopLogic.prototype = {
&nbsp;&nbsp;&nbsp;&nbsp;__name: 'LoopLogic',
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;loop: function() {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (var i = 0; 0 &lt; 1000000; i++) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i % 10000 === 0) h5.log.info(i);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
};</pre> loopメソッドはループを100万回回し、10000回ごとに周回数をコンソールに出力しています。
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>コントローラ<pre name="code" class="js">var loopController = {
&nbsp;&nbsp;&nbsp;&nbsp;__name: 'LoopController',
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;loopLogic: new LoopLogic(),
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;'#btn click': function() {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.loopLogic.loop();
&nbsp;&nbsp;&nbsp;&nbsp;}
};
&nbsp;
h5.core.controller('#container', loopController);</pre>
			ボタンがクリックされると、LoopLogic#loopを呼んでいます。
		</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<li>動作確認</li>
	</ul>
	<ul class="list1" style="padding-left: 12px; margin-left: 12px">
		<ul class="list2" style="padding-left: 12px; margin-left: 12px">
			<li><a href="../tutorial/step13-2/step13-2.html" rel="nofollow">チュートリアル/ステップ13-2</a></li>
			<li><a href="../recipe.html" rel="nofollow">デモサイトトップ</a></li>
		</ul>
</div>
<!-- CONTENTS_MAIN_END -->