<!doctype html>
<html lang="ja">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="UTF-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache">
		<meta http-equiv="Expires" content="-1">
		<link rel="stylesheet" href="../../release/h5.css"/>
		<title>Child2</title>
		<script src="../../lib/jquery/jquery.js"></script>
		<script src="../../release/h5.js"></script>
		<script>
			$(function() {
				var base = $("<table></table>");
				base.appendTo("#eventResult");
				clearResult();

				var base2 = $("<table></table>");
				base2.appendTo("#result");

				window.addEventListener('storage', addRowEventHandler);
			});

			function addRowEventHandler(ev) {
				var d = $("<tr></tr>");
				d.append("<td>"+ ev.key +"</td>");
				d.append("<td>"+ ev.oldValue +"</td>");
				d.append("<td>"+ ev.newValue +"</td>");
				d.append("<td>"+ ev.url +"</td>");
				d.append("<td>"+ (ev.storageArea == localStorage ? "Local Storage" : "Session Storage") +"</td>");
				d.children('td').css('border-width', '1px').css('border-style', 'solid');
				d.appendTo($("#eventResult table"));
			}

			function clearResult() {
				var base = $("#eventResult table");
				base.find("tr").remove();

				var tr = $("<tr></tr>");
				tr.append("<td>キー</td>");
				tr.append("<td>更新前の値</td>");
				tr.append("<td>更新後の値</td>");
				tr.append("<td>URL</td>");
				tr.append("<td>ストレージ</td>");
				tr.children('td').css('border-width', '2px').css('border-style', 'solid');
				tr.appendTo(base);
			}

			function addToStorage() {
				var st = null;
				if ($("input[type='radio']:checked").val() == "0") {
					st = h5.api.storage.local;
				} else {
					st = h5.api.storage.session;
				}

				var key = document.getElementById("storageKey").value;
				var val = document.getElementById("storageValue").value;

				if (!key || !val) {
					return;
				}

				var savedval = st.getItem(key);
				st.setItem(key, val);

				if (savedval == undefined) {
					alert("ストレージに値を登録しました。");
				} else {
					alert("ストレージの値を更新しました。");
				}

				document.getElementById("storageKey").value = "";
				document.getElementById("storageValue").value = "";
			}

			function removeValue() {
				var st = null;
				if ($("input[type='radio']:checked").val() == "0") {
					st = h5.api.storage.local;
				} else {
					st = h5.api.storage.session;
				}

				var key = document.getElementById("removeStorageKey").value;

				if (!key) {
					return;
				}

				if (st.getItem(key) == undefined) {
					alert(key + " はストレージに登録されていません。");
					return;
				}

				st.removeItem(key);
				alert(key + " がストレージから削除されました。");
				document.getElementById("removeStorageKey").value = "";
			}

			function toggleResult(button) {
				$('#result').toggle();
				button.value = button.value == "非表示" ? "表示" : "非表示";
			}
		</script>
	</head>
	<body style="background-color:pink">
		<h2>Child (other window)</h2>
		<div class="browserNotification">
		※ブラウザはできるだけ最新のバージョンをご利用ください。<br>
		　特に、IE6/7等の古いブラウザでは正しく動作しない場合があります。
		</div>
		<table style="width:100%">
			<tr>
				<td colspan="2">
					<h2>Parent</h2>
				</td>
			</tr>
			<tr>
				<td colspan="2">
					<input type="radio" value="0" name="storage" checked="checked"/>Local Storage
					<input type="radio" value="1" name="storage" />Session Storage
				</td>
			</tr>
			<tr>
				<td style="vertical-align:top;">
					<div>キー:<input type="text" id="storageKey"/></div>
					<div>値:<input type="text" id="storageValue"/></div>

				</td>
				<td style="vertical-align:top;">
					<div>キー:<input type="text" id="removeStorageKey"/></div>
				</td>
			</tr>
			<tr>
				<td>
					<input type="button" value="追加" onclick="addToStorage(); viewStorage();"/>
				</td>
				<td>
					<input type="button" value="削除" onclick="removeValue(); viewStorage();"/>
				</td>
			</tr>
		</table>
		<h4>Storage Event</h4>
		<div> Local Storage/Session Storageの内容が変更された場合、以下に結果が表示されます</div>
		<input type="button" value="クリア" onclick="clearResult();"/>
		<input type="button" value="イベント削除" onclick="window.removeEventListener('storage', addRowEventHandler);"/>
		<div id="eventResult"></div>
	</body>
</html>