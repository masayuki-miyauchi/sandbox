<!doctype html>
<html lang="ja">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="UTF-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache">
		<meta http-equiv="Expires" content="-1">
		<link rel="stylesheet" href="../../release/h5.css"/>
		<title>Storage Test (Parent)</title>
		<script src="../../lib/jquery/jquery.js"></script>
		<script src="../../release/h5.js"></script>
		<script>
			$(function() {
				h5.api.storage.local.clear();

				var base = $("<table></table>");
				base.appendTo("#eventResult");
				clearResult();

				var base2 = $("<table></table>");
				base2.appendTo("#result");

				window.addEventListener('storage', addRowEventHandler);

				// 文字列
				h5.api.storage.local.setItem("value", "AOT)(U$#UJO-JO!J");

				// 配列
				var array1 = ["ar1", "ar2", 30];
				h5.api.storage.local.setItem("ar", array1);

				// JSON
				var json = {'hoge1':'aaaa','hoge2':'bbb'};
				h5.api.storage.local.setItem("testA", json);

				// 数値
				h5.api.storage.local.setItem("hogehgoe", 200);

				// 関数
				var func = function() {
					alert("function");
				};
				h5.api.storage.local.setItem("f", func);

				// --------------- session storage --------------------------
				// 文字列
				h5.api.storage.session.setItem("value", "AOT)(U$#UJO-JO!J");

				// 配列
				var array1 = ["ar1", "ar2", 30];
				h5.api.storage.session.setItem("ar", array1);

				// JSON
				var json = {'hoge1':'aaaa','hoge2':'bbb'};
				h5.api.storage.session.setItem("testA", json);

				// 数値
				h5.api.storage.session.setItem("hogehgoe", 200);

				// 関数
				var func = function() {
					alert("function");
				};
				h5.api.storage.session.setItem("f", func);

				viewStorage();
				window.open("index_child.html", "childWindow");
			});

			function addRowEventHandler(ev) {
				viewStorage();

				var d = $("<tr></tr>");
				d.append("<td>"+ ev.key +"</td>");
				d.append("<td>"+ ev.oldValue +"</td>");
				d.append("<td>"+ ev.newValue +"</td>");
				d.append("<td>"+ ev.url +"</td>");
				d.append("<td>"+ (ev.storageArea == localStorage ? "Local Storage" : "Session Storage") +"</td>");
				d.children('td').css('border-width', '1px').css('border-style', 'solid');
				d.appendTo($("#eventResult table"));
			}

			function viewStorage() {
				var baseDiv = $("#result table");
				baseDiv.find("tr").remove();

				var tr2 = $("<tr></tr>");
				tr2.append("<td>ストレージ</td>");
				tr2.append("<td>キー</td>");
				tr2.append("<td>値</td>");
				tr2.children('td').css('border-width', '2px').css('border-style', 'solid');
				tr2.appendTo(baseDiv);

				h5.api.storage.local.each(function(i, k, v) {
					addResult(baseDiv, "Local Storage", k, v);
				});

				h5.api.storage.session.each(function(i, k, v) {
					addResult(baseDiv, "Session Storage", k, v);
				});
			}

			function addResult(base, type, key, value) {
				var tr = $("<tr></tr>");
				tr.append("<td>"+ type +"</td>");
				tr.append("<td>"+ key +"</td>");
				tr.append("<td>"+ value +"</td>");
				tr.children('td').css('border-width', '1px').css('border-style', 'solid');
				tr.appendTo(base);
			}

			function clearResult() {
				var base = $("#eventResult table");
				base.find("tr").remove();

				var tr = $("<tr></tr>");
				tr.append("<td>キー</td>");
				tr.append("<td>更新前の値</td>");
				tr.append("<td>更新後の値</td>");
				tr.append("<td>URL</td>");
				tr.append("<td>ストレージ</td>");
				tr.children('td').css('border-width', '2px').css('border-style', 'solid');
				tr.appendTo(base);
			}

			function addToStorage() {
				var st = null;
				if ($("input[type='radio']:checked").val() == "0") {
					st = h5.api.storage.local;
				} else {
					st = h5.api.storage.session;
				}

				var key = document.getElementById("storageKey").value;
				var val = document.getElementById("storageValue").value;

				if (!key || !val) {
					return;
				}

				var savedval = st.getItem(key);
				st.setItem(key, val);

				if (savedval == undefined) {
					alert("ストレージに値を登録しました。");
				} else {
					alert("ストレージの値を更新しました。");
				}

				document.getElementById("storageKey").value = "";
				document.getElementById("storageValue").value = "";
			}

			function removeValue() {
				var st = null;
				if ($("input[type='radio']:checked").val() == "0") {
					st = h5.api.storage.local;
				} else {
					st = h5.api.storage.session;
				}

				var key = document.getElementById("removeStorageKey").value;

				if (!key) {
					return;
				}

				if (st.getItem(key) == undefined) {
					alert(key + " はストレージに登録されていません。");
					return;
				}

				st.removeItem(key);
				alert(key + " がストレージから削除されました。");
				document.getElementById("removeStorageKey").value = "";
			}

			function toggleResult(button) {
				$('#result').toggle();
				button.value = button.value == "非表示" ? "表示" : "非表示";
			}
		</script>
	</head>
	<body>
		<div class="browserNotification">
		※ブラウザはできるだけ最新のバージョンをご利用ください。<br>
		　特に、IE6/7等の古いブラウザでは正しく動作しない場合があります。
		</div>
		<table>
			<tr>
				<td colspan="2" style="width:50%; border-width:1px 1px 1px 1px; border-style:solid; background-color:lemonchiffon">
					<table style="width:100%">
						<tr>
							<td colspan="2">
								<h2>Parent</h2>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="radio" value="0" name="storage" checked="checked"/>Local Storage
								<input type="radio" value="1" name="storage" />Session Storage
							</td>
						</tr>
						<tr>
							<td style="vertical-align:top;">
								<div>キー:<input type="text" id="storageKey"/></div>
								<div>値:<input type="text" id="storageValue"/></div>

							</td>
							<td style="vertical-align:top;">
								<div>キー:<input type="text" id="removeStorageKey"/></div>
							</td>
						</tr>
						<tr>
							<td>
								<input type="button" value="追加" onclick="addToStorage(); viewStorage();"/>
							</td>
							<td>
								<input type="button" value="削除" onclick="removeValue(); viewStorage();"/>
							</td>
						</tr>
					</table>
				</td>
				<td rowspan="2" style="width:50%; border-width:1px 1px 1px 1px; border-style:solid;">
					<iframe src="./index_inner.html" style="width:99%; height:100%; background-color:lightcyan"></iframe>
				</td>
			</tr>
			<tr>
				<td style="border-width:1px 1px 1px 1px; border-style:solid; vertical-align:top; background-color:lemonchiffon">
					<h4>Storage</h4><input type="button" value="非表示" onclick="toggleResult(this)"/>
					<div id="result"></div>
				</td>
				<td style="border-width:1px 1px 1px 1px; border-style:solid; vertical-align:top; background-color:lemonchiffon">
					<h4>Storage Event</h4>
					<div> Local Storage/Session Storageの内容が変更された場合、以下に結果が表示されます</div>
					<input type="button" value="クリア" onclick="clearResult();"/>
					<input type="button" value="イベント削除" onclick="window.removeEventListener('storage', addRowEventHandler);"/>
					<div id="eventResult"></div>
				</td>
			</tr>
			</tr>
		</table>
	</body>
</html>