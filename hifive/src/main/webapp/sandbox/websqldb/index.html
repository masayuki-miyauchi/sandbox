<!doctype html>
	<html lang="ja">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="UTF-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache">
		<meta http-equiv="Expires" content="-1">
		<title>Web SQL Database TEST</title>
		<link rel="stylesheet" href="../../release/h5.css"/>
		<link rel="stylesheet" href="websqldbSample.css"/>
		<script src="../../lib/jquery/jquery.js"></script>
		<script src="../../lib/ejs/ejs.js"></script>
		<script>
		$(document).bind('h5preinit', function() {
			h5.settings.log = {
				 defaultOut: {
				   level: 'trace',
				   targets: 'console'
				 }
			};

		});
		</script>
		<script src="../../release/h5.js"></script>
		<script src="sqldb.sample.js"></script>

		<!-- SyntaxHighlighter -->
		<link type="text/css" rel="stylesheet"
		    href="../../lib/syntaxhighlighter/styles/SyntaxHighlighter.css"></link>

		<script type="text/javascript"
		    src="../../lib/syntaxhighlighter/scripts/shCore.js"></script>
		<script type="text/javascript"
		    src="../../lib/syntaxhighlighter/scripts/shBrushXml.js"></script>
		<script type="text/javascript"
		    src="../../lib/syntaxhighlighter/scripts/shBrushJScript.js"></script>
		<script type="text/javascript">
		    window.onload = function() {
		        dp.SyntaxHighlighter.ClipboardSwf = '../../lib/syntaxhighlighter/scripts/clipboard.swf';
		        dp.SyntaxHighlighter.HighlightAll('code');
		    }
		</script>
	</head>
	<body>
		<div id="main">
			<div class="browserNotification">
				※ブラウザはできるだけ最新のバージョンをご利用ください。<br>
				　特に、IE6/7等の古いブラウザでは正しく動作しない場合があります。
			</div>
			<div class="desc">
				Web SQL Databaseを用いたおこづかい帳アプリのサンプルです。データを登録し、登録したデータの削除/更新を行うことができます。
			</div>
			<div id="app">
				<div id="resultWrap">
					<div id="product">
						品物を登録
						<br>
						<br>
						<span>品物：<input type="text" id="product_item" value="" maxlength=50/>
						</span><br>
						<span>単価：<input type="text" id="product_price" value="" style="text-align:right" />円
						</span><br>
						<button id="product_regist">登録</button>
						<button id="product_clear" >クリア</button>
						<br>
						<br>
						<br>
						<br>
						<h2>品物</h2>
						<table id="productTable">
							<thead>
								<tr>
									<th>品物名</th>
									<th>単価</th>
									<th>編集</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
					<div id="result">
						買ったものを登録
						<br>
						<br>
						<span>購入日：<input type="text" id="account_date" maxlength=10 value=""/>
						</span><br>
						<span>品物名：<input type="text" id="account_item" />
						</span><br>
						<span>購入数：<input type="text" id="account_num" style="text-align:right"/>個
						</span><br>
						<button id="account_regist"">登録</button>
						<button id="account_clear" >クリア</button>
						<br>
						<br>
						<h2>買い物履歴</h2>
						<table id="resultTable">
							<thead>
								<tr>
									<th>購入日</th>
									<th>品物</th>
									<th>個数</th>
									<th>小計</th>
									<th>編集</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
					<div style="clear:both"></div>
				</div>
				<div>
					<br>
					<button id="drop" >DROP</button>このアプリが作成したテーブルをDROPします。テスト用。
				</div>
			</div>
			<hr>
			<div class="desc">
			このサンプルアプリを例に<a target="_blank" href="../../doc/h5.api.sqldb.html">h5.api.sqldb</a>の解説を行います。
			<article>
				<section>
					<a name="schema"></a>
					<h2>スキーマ</h2>
					<img src="db.png">
				</section>
				<section>
					<a name="connectDB"></a>
					<h2>データベースに接続する</h2>

<pre name="code" class="js">
db = h5.api.sqldb.open('hcdb', '1', 'hcdb', 2 * 1024 * 1024);
</pre>
					<p>
						<a href="../../doc/h5.api.sqldb.html#open" target="_blank">h5.api.sqldb.open</a>を使ってローカル領域のデータベースへ接続します。
						戻り値は<a href="../../doc/DatabaseWrapper.html" target="_blank">DatabaseWrapper</a>オブジェクトです。
					</p>
				</section>
				<section>
					<a name="transaction"></a>
					<h2>トランザクション</h2>
<pre name="code" class="js">
var promise = db.transaction().add(db.select()...).add(db.insert()...)
  .add(db.update()...).add(db.del()...).add(db.sql()...).execute();
promise.done(function(){
	// トランザクション正常終了時に行う処理
}).fail(function(error){
	// トランザクション異常終了時に行う処理
});
</pre>
					<p>
						db.transaction()にトランザクション内で行いたい処理をadd()を使って渡し、execute()メソッドでトランザクションを実行します。
						このメソッドは非同期で実行され、promiseオブジェクトを返します。
						トランザクションが成功/失敗すると、done()/fail()に登録された関数が実行されます。
					</p>
					<p>
						transaction実行中にエラーが発生した場合は、自動でロールバックされます。
					</p>
					<p>
						sql(), select(), insert(), del(), update()は単独でも実行できます。db.sql().execute()のようにして実行し、transaction()と同様にpromiseオブジェクトを返します。
						各メソッドの使い方はこのページでも解説しますが、詳細は<a href="../../doc/Transaction.html" target="_blank">Transaction</a>(APIドキュメント)をご覧ください。
					</p>
				</section>
				<section>
					<h2>sql()</h2>
					<p>サンプルアプリで使用しているテーブルを作成するソースコードの解説をします。</p>
					<p>データベースの操作は基本的にロジック内で行います。</p>
<pre name="code" class="js" title="SampleSqldbLogic">
	var dfd = h5.async.deferred();
	var promise = db.sql(
					'CREATE TABLE PRODUCT ('
						+ 'item CHAR(20) NOT NULL'
						+ ', price INTEGER NOT NULL'
						+ ', CONSTRAINT PK_PRODUCT PRIMARY KEY (item));')).execute();
	promise.fail(function(err) {
		dfd.reject(err);
	}).done(function() {
		dfd.resolve('データベースにテーブル"PRODUCT"を新規作成しました。');
	});
	return dfd.promise();
</pre>

					<p>
						PRODUCTテーブルを作成するロジック内の関数です。db.sql()でSQLを実行しています。
					</p>
					<p>
						sql()はpromiseオブジェクトを返します。クエリの実行に成功/失敗すると、done()/fail()に登録された関数が実行されます。
					</p>
					<p>
						失敗した場合はfail内の関数にSQLErrorオブジェクトが渡されます。
					</p>
					<p>
						成功した場合はdone内の関数にSQLResultSetオブジェクトが渡されます。
						この例ではCRETE文なので結果は空ですが、SELECT文やUPDATE文を実行すると結果が格納されたSQLResultSetオブジェクトが渡されます。
					</p>
				</section>
				<section>
					<h2>select()</h2>
<pre name="code" class="js" title="SampleSqldbLogic#selectProduct">
var dfd = h5.async.deferred();
db.select('PRODUCT', '*').orderBy('item').execute().done(function(rows) {
		var resultArray = [];
		for ( var i = 0, len = rows.length; i < len; i++) {
			resultArray.push({
				item: rows.item(i)['item'],
				price: rows.item(i)['price'],
			});
		}
		dfd.resolve(resultArray);
	}).fail(function(err) {
		dfd.reject(err);
	});
});
</pre>
					<p>
						sql()でSELECT文を記述して実行することもできますが、単純なSELECT文であればselect()使って実行することができます。
						第一引数に取得するテーブル名、第二引数に取得するカラム名を指定します。第二引数はカラム名の配列または'*'で指定します。
					</p>
					<p>
						ORDER BY句はorderBy()で設定できます。詳しくは<a target="_blank" href="../../doc/Select.html#orderBy">Select#orderBy</a>をご覧ください。
					</p>
					<p>
						またWHERE句をwhere()で設定できます。詳しくは<a target="_blank" href="../../doc/Select.html#where">Select#where</a>をご覧ください。
					</p>
					<p>
						処理が成功すると、done()内の関数にSQLResultSetRowListオブジェクトが引数に渡されます。
						この例ではSELECTの実行結果を取り出し、配列に格納して呼び出し元に返しています。
					</p>
					<p>
						select()では実行できないようなSELECT文を使うには、sql()を使ってSELECT文を記述して実行します。
						以下は、買い物履歴を取得するソースコードです。
					</p>
<pre name="code" class="js" title="SampleSqldbLogic#selectAccount">
db.sql(
	'SELECT date, ACCOUNT.item, num, (num * price) as total, key'
	+ ' FROM ACCOUNT LEFT OUTER JOIN PRODUCT'
	+ ' ON ACCOUNT.item = PRODUCT.item'
	+ ' ORDER BY date DESC').execute()
.done(function(rs) {
	var resultArray = [];
	for ( var i = 0, len = rs.rows.length; i < len; i++) {
		resultArray.push({
			date: rs.rows.item(i)['date'],
			item: rs.rows.item(i)['item'],
			num: rs.rows.item(i)['num'],
			total: rs.rows.item(i)['total'],
			key: rs.rows.item(i)['key']
		});
	}
	dfd.resolve(resultArray);
}).fail(function(err) {
	dfd.reject(err);
});
</pre>
				</section>
				<section>
					<h2>INSERT</h2>
<pre name="code" class="js" title="SampleSqldbLogic#insertProduct">
var dfd = h5.async.deferred();
db.insert('PRODUCT').where({
		item: item,
		price: price
	}).execute().done(function(rs) { // 第一引数: 登録したレコードのROWIDの配列
		dfd.resolve();
	})
	.fail(function(err) {
		dfd.reject(err);
	});
</pre>
					<p>
						単純なINSERT文はinsert()を使って実行することができます。登録したいデータをオブジェクトに格納して引数に渡します。
						doneに指定したコールバック関数には、登録されたレコードのROWIDが配列で格納されます。
					</p>
				</section>
				<section>
					<h2>UPDATE</h2>
<pre name="code" class="js" title="SampleSqldbLogic#updateProduct">
var dfd = h5.async.deferred();
db.update('ACCOUNT', dataObj).where({
		'key =': dataObj.key
	}).execute().done(function() {
		dfd.resolve();
	}).fail(function(err) {
		dfd.reject(err);
	});
});
</pre>
					<p>
						単純なUPDATE文はupdate()を使って実行することができます。テーブル名と、更新したいデータを格納したオブジェクトを引数に渡します。
					</p>
					<p>
						WHERE句はwhere()で設定できます。このWHERE句の指定方法はselect文と同様です。詳しくは<a target="_blank" href="../../doc/Update.html#where">Update#where</a>をご覧ください。
					</p>
				</section>
				<section>
					<h2>DELETE</h2>
<pre name="code" class="js" title="SampleSqldbLogic#delAccount">
var dfd = h5.async.deferred();
db.del('PRODUCT').where({
		'item =': item
	}).execute().done(function() {
		dfd.resolve();
	}).fail(function(err) {
		dfd.reject(err);
	});

});
</pre>
					<p>
						単純なDELETE文はdel()を使って実行することができます。
						WHERE句はwhere()で設定できます。このWHERE句の指定方法はselect文と同様です。詳しくは<a target="_blank" href="../../doc/Del.html#where">Del#where</a>をご覧ください。
					</p>
				</section>
				<section>
					<h2>DROP文とロールバック</h2>
					<p>
						テーブルの削除とロールバックについて説明します。
					</p>
<pre name="code" class="js" >
var dfd = h5.async.deferred();
db.sql('DROP TABLE ACCOUNT').execute().progress(function(rs,tx) {
	dfd.notify('ACCOUNTテーブルを削除しました。');
	// sql()にトランザクションオブジェクトtxを渡して、トランザクションを引き継ぐことができる。
	db.sql('DROP TABLE PRODUCT', [], tx).execute().progress(function(rs,tx){
		dfd.notify('PRODUCTテーブルを削除しました。');
	})
}).done(function() {
	dump('トランザクション成功：テーブルは２つとも削除されました。');
	dfd.resolve();
}).fail(function(err) {
	dump('トランザクション失敗：テーブルは２つとも削除されていません。');
	dfd.reject(err);
});
dfd.progress(function(msg) {
	dump(msg);
});
</pre>
					<p>
						テーブルの削除(DROP)はsql()にSQL文を渡して実行します。
					</p>
					<p>
						sql(), select(), insert(), del(), update()の、progress()に指定したコールバック関数の第二引数には、トランザクションオブジェクトが格納され、
						このオブジェクトを使用することで、トランザクションを引き継ぐことができます。
						この例では、ACCOUNTテーブルのDROP文を実行するトランザクションで、PRODUCTテーブルのDROP文を実行します。
					</p>
					<p>
						トランザクション内でエラーが発生すると、その同一トランザクション内の処理は自動的にロールバックされ、fail()コールバックが実行されます。
						この例では、トランザクション終了時には２つとも削除された状態か、ロールバックされてどちらも削除されていない状態のどちらかになります。

					</p>
				</section>
			</article>
			</div>
		</div>
		<div id ="dump" style="margin-top: 0px;height: 200px;  overflow: scroll; overflow-x:hidden; border:solid 1px gray">
		<h2>処理のdump</h2>
			<ul id="ul"></ul>
		</div>
	</body>
</html>