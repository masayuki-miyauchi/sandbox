<!DOCTYPE HTML>
<html lang="ja">
	<head>
		<meta charset="UTF-8">
		<title>Web SQL Database レコード編集ツール</title>
		<style>
			table {
				border-collapse: collapse;
				border-left: #cccccc 1px solid;
				border-bottom: #cccccc 1px solid;
				text-align: center;
			}

			#title {
				background-color: #f0f0f0;
			}

			#content {
				background-color: #ffffff;
			}

			td {
				padding: 3px;
				border-top: #cccccc 1px solid;
				border-right: #cccccc 1px solid;
			}
		</style>
		<script>
			var rowCount = 1;
			var db = null;

			function isConnection() {
				return db != null;
			}

			function getConnection() {
				var resultField = document.getElementById("result");
				var dbName = document.getElementById('databaseName').value;
				var version = document.getElementById("databaseVersion").value;

				resultField.innerHTML = "";

				if (dbName == "") {
					alert("データベース名を入力してください。");
					return;
				}
				try {
					db = openDatabase(dbName, version, "Web SQL Database", 1024*1024);

					resultField.innerHTML = dbName +"に接続しました。 Version:"+ db.version;
				} catch(e) {
					resultField.innerHTML = "データベースの接続に失敗しました。"+ e;
					db = null;
				}
			}

			function updateVersion() {
				if (!isConnection()) {
					alert("データベースに接続されていません。");
					return;
				}

				var newVersion = document.getElementById("version").value;
				var resultField = document.getElementById("result");

				db.changeVersion(db.version, newVersion,
					function(tx) {
						resultField.innerHTML = "バージョンの更新完了。newVersion:"+ newVersion;
					},
					function(error) {
						resultField.innerHTML = "バージョンの更新に失敗しました。ErroCode:" + error.code + ", Message:" + error.message;
					},
					function() {});
			}

			function dropTableInnter(tableName) {
				if (!isConnection()) {
					alert("データベースに接続されていません。");
					return;
				}

				if (tableName.value == "") {
					alert("テーブル名を入力してください。");
					return;
				}

				var resultField = document.getElementById("result");

				db.transaction(
					function(tx) {
						tx.executeSql("DROP TABLE "+ tableName);
					},
					function(error) {
						resultField.innerHTML = "テーブルの削除に失敗しました。ErroCode:" + error.code + ", Message:" + error.message;
					},
					function() {
						resultField.innerHTML = "テーブルを削除しました。";
					});
			}

			function dropTable() {
				var tableName = document.getElementById("tableName").value;
				dropTableInnter(tableName);
			}

			function dropAllTable() {
				if (!isConnection()) {
					alert("データベースに接続されていません。");
					return;
				}

				var descSql = "select name from sqlite_master where type = \"table\"";
				db.transaction(function(tx){
					tx.executeSql(descSql, [], function(tx, rs){
						for (var i = 0; i < rs.rows.length; i++) {
							var tableName = rs.rows.item(i).name;
							if ("__WebKitDatabaseInfoTable__" != tableName) {
								dropTableInnter(tableName);
							}
						}
					});
				}, function(error){
					console.log(error.code + ":" + error.message);
				}, function(){
					console.log("テーブルが全て削除されました。");
				});
			}

			function isValidQueryField() {
				var inputTableNameField = document.getElementById("query");

				if (inputTableNameField.value == "") {
					alert("クエリを入力してください。");
					return false;
				}

				return true;
			}

			function executeQuery() {
				if (!isValidQueryField()) {
					return;
				}

				if (!isConnection()) {
					alert("データベースに接続されていません。");
					return;
				}

				var resultField = document.getElementById("result");
				resultField.innerHTML = "";

				db.transaction(
				function(tx) {
					var queryArray = readLine(document.getElementById("query").value);

					for (var i = 0; i < queryArray.length; i++) {
						if (queryArray[i] == "") {
							continue;
						}

						var cbCurrentIdx = 0;

						tx.executeSql(queryArray[i], [],
							function(tx, rs) {
								resultQuery(tx, rs, queryArray[cbCurrentIdx++], resultField);
							},
							function(tx, error) {
								if (resultField.innerHTML.length > 0) {
									resultField.innerHTML += "<br/>";
								}
								resultField.innerHTML += "ErroCode:" + error.code + ", Message:" + error.message;
								cbCurrentIdx++;
							});
					}
				});
			}

			function readLine(source) {
				return source.replace(/\r\n/g, "\n").replace(/\r|\n/g, "\n").split(";");
			}

			function resultQuery(tx, rs, query, resultField) {
				var queryType = getQueryType(query);
				var result = "";

				if (queryType == INSERT) {
					if (resultField.innerHTML.length > 0) {
						resultField.innerHTML += "<br/>";
					}
					result = "レコードが登録されました。count:"+ rs.rowsAffected;
					resultField.innerHTML += result;
					return;
				}

				if (queryType == UPDATE) {
					if (resultField.innerHTML.length > 0) {
						resultField.innerHTML += "<br/>";
					}

					if (rs.rowsAffected > 0) {
						result = "レコードが更新されました。count:"+ rs.rowsAffected;
					} else {
						result = "更新対象のレコードがありません。";
					}

					resultField.innerHTML += result;
					return;
				}

				if (queryType == DELETE) {
					if (resultField.innerHTML.length > 0) {
						resultField.innerHTML += "<br/>";
					}

					if (rs.rowsAffected > 0) {
						result = "レコードが削除されました。count:"+ rs.rowsAffected;
					} else {
						result = "削除対象のレコードがありません。";
					}

					resultField.innerHTML += result;
					return;
				}

				if (queryType == OTHER) {
					if (resultField.innerHTML.length > 0) {
						resultField.innerHTML += "<br/>";
					}
					result = "正常に処理されました。";
					resultField.innerHTML += result;
					return;
				}

				if (queryType == SELECT && rs.rows.length == 0) {
					if (resultField.innerHTML.length > 0) {
						resultField.innerHTML += "<br/>";
					}
					result = "取得件数 0件";
					resultField.innerHTML += result;
					return;
				}

				result += "<div>";
				result += "result:";
				result += rs.rows.length;
				result += "</div>";

				result += "<table style='width:600'>";
				result += "<tr>";

				// テーブルのタイトル行にカラム名を設定
				for (var prop in rs.rows.item(0)) {
					result += "<td style='font-size:15'>" + prop +"</td>";
				}
				result += "</tr>";

				// レコード
				for (var j = 0; j < rs.rows.length; j++) {
					var row = rs.rows.item(j);
					result += "<tr>";

					for (var prop in row) {
						result += "<td>" + row[prop] +"</td>";
					}

					result += "</tr>";
				}

				result += "</table>";
				resultField.innerHTML += result;
				return;
			}

			//クエリの種類
			var SELECT = 0;
			var INSERT = 1;
			var UPDATE = 2;
			var DELETE = 3;
			var OTHER = 4;

			function getQueryType(query) {
				if (query == null) {
					return OTHER;
				}
				if (query.toLowerCase().indexOf("select") > -1) {
					return SELECT;
				}
				if (query.toLowerCase().indexOf("insert") > -1) {
					return INSERT;
				}
				if (query.toLowerCase().indexOf("update") > -1) {
					return UPDATE;
				}
				if (query.toLowerCase().indexOf("delete") > -1) {
					return DELETE;
				}

				return OTHER;
			}
		</script>
	</head>
	<body>
		<h3>Web SQL Database Test</h3>
		<div id="result"></div>
		<br>
		<h4>データベース接続 (存在しないデータベースに接続した場合、新規に作成されます)</h4>
		<div>
			データベース名:<input type="text" id="databaseName" value="hcdb">
			バージョン:<input type="text" id="databaseVersion" value="1">
			<button onclick="getConnection();">接続</button>
		</div>
		<h4></h4>
		<table>
			<tr>
				<td>バージョン更新</td>
				<td><input type="text" id="version" value="1"><button onclick="updateVersion();">更新</button></td>
			</tr>
			<tr >
				<td>テーブル削除</td>
				<td><input type="text" id="tableName"><button onclick="dropTable();">削除</button></td>
			</tr>
			<tr >
				<td>全テーブル削除</td>
				<td><button onclick="dropAllTable();">削除</button></td>
			</tr>
		</table>
		<h4>クエリを実行【行単位で複数クエリ実行可】</h4>
		<div>
			<button onclick="executeQuery();">クエリを実行</button><br/>
			<textarea rows="20" cols="70" id="query"></textarea>
		</div>
	</body>
</html>
